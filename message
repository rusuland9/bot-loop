#!/usr/bin/env python3
"""
slack_people_from_env.py
Reads SLACK_COOKIE and SLACK_XOXC from .env and sends the same
POST request to the Slack internal endpoint you captured.

Produces:
 - people-info.json  (if JSON returned)
 - slack_people_raw.txt       (if non-JSON text returned)
 - people-info.html (if HTML returned, e.g. login)
"""

import os
import json
import sys
import requests
import uuid
from dotenv import load_dotenv

load_dotenv()  # loads .env into environment

# Ensure stdout can print Unicode symbols (e.g., checkmarks, warning signs) on Windows consoles
try:
    sys.stdout.reconfigure(encoding="utf-8")
except Exception:
    pass

COOKIE = os.getenv("SLACK_COOKIE", "").strip()
XOXC_TOKEN = os.getenv("SLACK_XOXC", "").strip()
SLACK_CHANNEL = os.getenv("SLACK_CHANNEL", "D09JMFEZL3").strip()
SLACK_TEXT = os.getenv("SLACK_TEXT", "Hi").strip()

if not COOKIE or not XOXC_TOKEN:
    print("ERROR: please set SLACK_COOKIE and SLACK_XOXC in your .env file")
    sys.exit(1)

REQUEST_URL = (   
    "https://shopifypartners.slack.com/api/chat.postMessage"
    "?_x_id=58298780-1759777468.497"
    "&_x_csid=CeL_-ij1pYI"
    "&slack_route=T4BB7S7HP"
    "&_x_version_ts=1759765056"
    "&_x_frontend_build_type=current"
    "&_x_desktop_ia=4"
    "&_x_gantry=true"
    "&fp=e3"
    "&_x_num_retries=0"
)

_blocks = [
    {
        "type": "rich_text",
        "elements": [
            {
                "type": "rich_text_section",
                "elements": [
                    {"type": "text", "text": SLACK_TEXT}
                ],
            }
        ],
    }
]

FORM_FIELDS = {
    "channel": SLACK_CHANNEL,
    "ts": os.getenv("SLACK_TS", ""),
    "type": "message",
    "xArgs": "{}",
    "unfurl": "[]",
    "client_context_team_id": "T4BB7S7HP",
    "blocks": json.dumps(_blocks, separators=(",", ":")),
    "include_channel_perm_error": "true",
    "client_msg_id": str(uuid.uuid4()),
    "_x_reason": "webapp_message_send",
    "_x_mode": "online",
    "_x_sonic": "true",
    "_x_app_name": "client",
}

def build_session_from_cookie(cookie_header: str) -> requests.Session:
    s = requests.Session()
    # parse the cookie string into name/value pairs and set in session cookiejar
    pairs = [p.strip() for p in cookie_header.split(";") if p.strip()]
    for p in pairs:
        if "=" in p:
            name, value = p.split("=", 1)
            # set cookie for the slack domain
            s.cookies.set(name.strip(), value.strip(), domain="shopifypartners.slack.com")
    return s

def main():
    s = build_session_from_cookie(COOKIE)

    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36",
        "Accept": "*/*",
        "Accept-Language": "ja,en;q=0.9,en-US;q=0.8,zh-CN;q=0.7,zh;q=0.6,id;q=0.5,de;q=0.4",
        "Origin": "https://app.slack.com",
        "Referer": f"https://app.slack.com/client/T4BB7S7HP/{SLACK_CHANNEL}",
        # client-hint headers (optional)
        "Sec-CH-UA": '"Google Chrome";v="141", "Not?A_Brand";v="8", "Chromium";v="141"',
        "Sec-CH-UA-Platform": '"Windows"',
    }

    # build multipart fields. Using requests `files` with (None, value) sends form-data
    files = {k: (None, v) for k, v in FORM_FIELDS.items()}
    files["token"] = (None, XOXC_TOKEN)

    print("Sending request...")
    resp = s.post(REQUEST_URL, headers=headers, files=files, timeout=30, allow_redirects=True)

    print("HTTP", resp.status_code)
    ct = resp.headers.get("Content-Type", "")

    text = resp.text

    # detect HTML/login
    if "text/html" in ct or "<!doctype html" in text.lower() or "login" in resp.url.lower():
        print("⚠️ Received HTML (login page or redirect). Your cookie/token may be invalid.")
        with open("people-info.html", "w", encoding="utf-8") as f:
            f.write(text)
        print("Saved people-info.html for inspection.")
        return

    # try parse JSON
    try:
        j = resp.json()
    except ValueError:
        print("⚠️ Response not JSON. Saving raw text.")
        with open("slack_people_raw.txt", "w", encoding="utf-8") as f:
            f.write(text)
        print("Saved slack_people_raw.txt")
        return

    with open("people-info.json", "w", encoding="utf-8") as f:
        json.dump(j, f, indent=2, ensure_ascii=False)

    print("✅ Saved people-info.json")
    # print a small summary
    if isinstance(j, dict) and "items" in j:
        print("Items returned:", len(j["items"]))
    else:
        print("Top-level JSON keys:", list(j.keys()) if isinstance(j, dict) else "non-dict")

if __name__ == "__main__":
    main()
